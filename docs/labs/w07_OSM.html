<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.546">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Gabriele Filomena">
<meta name="dcterms.date" content="2024-02-12">

<title>Web Mapping and Geovisualisation - 6&nbsp; Retrieving Data From OpenStreetMap</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../labs/w05_dataArch.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../labs/w07_OSM.html"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Retrieving Data From OpenStreetMap</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Web Mapping and Geovisualisation</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/GDSL-UL/wma" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <a href="../Web-Mapping-and-Geovisualisation.pdf" title="Download PDF" class="quarto-navigation-tool px-1" aria-label="Download PDF"><i class="bi bi-file-pdf"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../general/structure.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Syllabus</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../general/overview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Overview</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../general/assessments.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Assessments</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../general/setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Setting up the Working Environment</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../labs/w01_intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction &amp; Python Refresher</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../labs/w02_maps.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Static Maps in Python</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../labs/w03_webArch.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Web Architectures and APIs</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../labs/w04_interactive.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Interactive Maps</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../labs/w05_dataArch.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Data Architectures and Tiles</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../labs/w07_OSM.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Retrieving Data From OpenStreetMap</span></span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#what-is-openstreetmap" id="toc-what-is-openstreetmap" class="nav-link active" data-scroll-target="#what-is-openstreetmap"><span class="header-section-number">6.1</span> What is OpenStreetMap?</a>
  <ul class="collapse">
  <li><a href="#main-tools-in-this-lesson" id="toc-main-tools-in-this-lesson" class="nav-link" data-scroll-target="#main-tools-in-this-lesson"><span class="header-section-number">6.1.1</span> Main tools in this lesson</a></li>
  </ul></li>
  <li><a href="#download-manipulate-and-visualise-openstreetmap-data-with-osmnx" id="toc-download-manipulate-and-visualise-openstreetmap-data-with-osmnx" class="nav-link" data-scroll-target="#download-manipulate-and-visualise-openstreetmap-data-with-osmnx"><span class="header-section-number">6.2</span> Download, manipulate, and visualise OpenStreetMap data with OSMnx</a>
  <ul class="collapse">
  <li><a href="#boundaries-from-openstreetmap" id="toc-boundaries-from-openstreetmap" class="nav-link" data-scroll-target="#boundaries-from-openstreetmap"><span class="header-section-number">6.2.1</span> Boundaries from OpenStreetMap</a></li>
  <li><a href="#download-and-model-street-networks" id="toc-download-and-model-street-networks" class="nav-link" data-scroll-target="#download-and-model-street-networks"><span class="header-section-number">6.2.2</span> Download and model Street Networks</a></li>
  <li><a href="#simplifying-and-cleaning-the-street-network-topology" id="toc-simplifying-and-cleaning-the-street-network-topology" class="nav-link" data-scroll-target="#simplifying-and-cleaning-the-street-network-topology"><span class="header-section-number">6.2.3</span> Simplifying and Cleaning the Street Network Topology</a></li>
  <li><a href="#from-osmnx-to-networkx-and-geopandas-classes" id="toc-from-osmnx-to-networkx-and-geopandas-classes" class="nav-link" data-scroll-target="#from-osmnx-to-networkx-and-geopandas-classes"><span class="header-section-number">6.2.4</span> From OSMNX to NetworkX and Geopandas Classes</a></li>
  </ul></li>
  <li><a href="#routing-with-networkx" id="toc-routing-with-networkx" class="nav-link" data-scroll-target="#routing-with-networkx"><span class="header-section-number">6.3</span> Routing with NetworkX</a></li>
  <li><a href="#fetching-other-networks-with-osmnx" id="toc-fetching-other-networks-with-osmnx" class="nav-link" data-scroll-target="#fetching-other-networks-with-osmnx"><span class="header-section-number">6.4</span> Fetching other networks with OSMNX</a></li>
  <li><a href="#retrieving-other-osm-data" id="toc-retrieving-other-osm-data" class="nav-link" data-scroll-target="#retrieving-other-osm-data"><span class="header-section-number">6.5</span> Retrieving Other OSM data</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.dev/GDSL-UL/wma/blob/main/labs/w07_OSM.ipynb" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Retrieving Data From OpenStreetMap</span></h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Gabriele Filomena </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">February 12, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p><em>Gabriele Filomena has readapted parts of this <a href="https://github.com/mszell/geospatialdatascience/blob/main/unit08_openstreetmap/lecture08.ipynb">notebook</a></em> for preparing this notebook. Copyright (c) Michael Szell. Original sources include:</p>
<ul>
<li>OSMnx examples: https://github.com/gboeing/osmnx-examples</li>
<li>pyrosm examples: https://pyrosm.readthedocs.io/en/latest/basics.html#read-street-networks</li>
</ul>
<p>The <strong>Lecture slides</strong> can be found <a href="https://github.com/GDSL-UL/wma/raw/main/html/w07.html">here</a>.</p>
<p>This <strong>lab</strong>’s notebook can be downloaded from <a href="https://github.com/GDSL-UL/wma/blob/main/labs/w07_osm.ipynb">here</a>.</p>
<section id="what-is-openstreetmap" class="level2" data-number="6.1">
<h2 data-number="6.1" class="anchored" data-anchor-id="what-is-openstreetmap"><span class="header-section-number">6.1</span> What is OpenStreetMap?</h2>
<p>OpenStreetMap is a free and open map service. It is a collaborative global effort to collect free and open geodata. <em>Source: <a href="https://wiki.openstreetmap.org/wiki/Logos">wiki.openstreetmap.org</a></em>. OpenStreetMap (OSM) is a global collaborative (crowd-sourced) database and project that aims at creating a free editable map of the world containing of information about our environment. It contains data about streets, buildings, different services, and landuse, to mention just a few.</p>
<p>OSM has more than 8 million registered users who contribute around 4 million changes daily. Its database contains data that is described by <a href="http://wiki.openstreetmap.org/wiki/Stats">more than 7 billion nodes</a> (that make up lines, polygons and other objects). While the most well-known side of OpenStreetMap is the map itself, the project is much more than that. OSM’s data can be used for many other purposes such as <strong>routing</strong>, <strong>geocoding</strong>, <strong>education</strong>, and <strong>research</strong>. OSM is also widely used for humanitarian response, e.g., in crisis areas (e.g.&nbsp;after natural disasters) and for fostering economic development. Read more about humanitarian projects that use OSM data from the <a href="https://www.hotosm.org">Humanitarian OpenStreetMap Team (HOTOSM) website</a>.</p>
<section id="main-tools-in-this-lesson" class="level3" data-number="6.1.1">
<h3 data-number="6.1.1" class="anchored" data-anchor-id="main-tools-in-this-lesson"><span class="header-section-number">6.1.1</span> Main tools in this lesson</h3>
<section id="osmnx" class="level4" data-number="6.1.1.1">
<h4 data-number="6.1.1.1" class="anchored" data-anchor-id="osmnx"><span class="header-section-number">6.1.1.1</span> OSMnx</h4>
<p>This week we will explore a Python package called <a href="https://github.com/gboeing/osmnx"><code>OSMnx</code></a> that can be used to retrieve street networks from OpenStreetMap, and construct, analyse, and visualise them. <code>OSMnx</code> can also fetch most of the other data stored in OSM, such as building footprints, transport networks, parks, Points of Interest, etc..<code>OSMNx</code> also includes tools to find routes on a network downloaded from OpenStreetMap, and implements algorithms for finding shortest connections for walking, cycling, or driving.</p>
<p>To get an overview of the capabilities of the package, please refer to the following scientific article describing the package:</p>
<blockquote class="blockquote">
<p>Boeing, G. 2017. <a href="https://www.researchgate.net/publication/309738462_OSMnx_New_Methods_for_Acquiring_Constructing_Analyzing_and_Visualizing_Complex_Street_Networks">“OSMnx: New Methods for Acquiring, Constructing, Analyzing, &gt; and Visualizing Complex Street &gt; Networks.”</a> Computers, Environment and Urban Systems 65, 126-139. doi:10.1016/j.compenvurbsys.2017.05.004</p>
</blockquote>
</section>
<section id="networkx" class="level4" data-number="6.1.1.2">
<h4 data-number="6.1.1.2" class="anchored" data-anchor-id="networkx"><span class="header-section-number">6.1.1.2</span> NetworkX</h4>
<p>We will also use <a href="https://networkx.github.io/documentation//"><code>NetworkX</code></a> to manipulate and analyse the street network data retrieved from OpenStreetMap. NetworkX is a Python package that can be used to create, manipulate, and study the structure, dynamics, and functions of complex networks. <code>OSMNx</code> is built on top <code>NetworkX</code> and <code>GeoPandas</code>.</p>
<div id="cell-3" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> osmnx <span class="im">as</span> ox</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> networkx <span class="im">as</span> nx</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>matplotlib inline</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
</section>
<section id="download-manipulate-and-visualise-openstreetmap-data-with-osmnx" class="level2" data-number="6.2">
<h2 data-number="6.2" class="anchored" data-anchor-id="download-manipulate-and-visualise-openstreetmap-data-with-osmnx"><span class="header-section-number">6.2</span> Download, manipulate, and visualise OpenStreetMap data with OSMnx</h2>
<p>A useful feature of <code>OSMNx</code> is its easy-to-use tools to download <a href="http://www.openstreetmap.org">OpenStreetMap</a> data via the project’s <a href="http://wiki.openstreetmap.org/wiki/Overpass_API">OverPass API</a>. In this section, we will learn how to download and visualise the street network and additional data from OpenStreetMap covering different areas of interest.</p>
<section id="boundaries-from-openstreetmap" class="level3" data-number="6.2.1">
<h3 data-number="6.2.1" class="anchored" data-anchor-id="boundaries-from-openstreetmap"><span class="header-section-number">6.2.1</span> Boundaries from OpenStreetMap</h3>
<p><code>OSMnx</code> lets you download place boundary geometries from OpenStreetMap, project them, and plot them. For a more in-depth demonstration of querying by place, see <a href="03-graph-place-queries.ipynb">this notebook</a>.</p>
<div class="alert alert-info" style="font-size:120%">
<p><strong>Important</strong>: <br></p>
<p>Data downloaded from OSM are always in the WGS crs. You need to convert it for any type of spatial operation or computation to the appropriate coordinate reference system.</p>
</div>
<div id="cell-7" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get the boundary polygon for manhattan, project it, and plot it</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>city <span class="op">=</span> ox.geocode_to_gdf(<span class="st">"Manhattan"</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> city.plot(fc<span class="op">=</span><span class="st">"gray"</span>, ec<span class="op">=</span><span class="st">"none"</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>ax.axis(<span class="st">"off"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="w07_OSM_files/figure-html/cell-3-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-8" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>bulgaria <span class="op">=</span> ox.geocode_to_gdf(<span class="st">"Bulgaria"</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> bulgaria.plot(fc<span class="op">=</span><span class="st">"gray"</span>, ec<span class="op">=</span><span class="st">"none"</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>ax.axis(<span class="st">"off"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="w07_OSM_files/figure-html/cell-4-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-9" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get boundary polygons for several authorities in the UK, and plot</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>place_names <span class="op">=</span> [<span class="st">"Merseyside"</span>, <span class="st">"Greater Manchester"</span>, <span class="st">"Cheshire"</span>]</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>places <span class="op">=</span> ox.geocode_to_gdf(place_names)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> places.plot(fc<span class="op">=</span><span class="st">"gray"</span>, ec<span class="op">=</span><span class="st">"red"</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> ax.axis(<span class="st">"off"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="w07_OSM_files/figure-html/cell-5-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="download-and-model-street-networks" class="level3" data-number="6.2.2">
<h3 data-number="6.2.2" class="anchored" data-anchor-id="download-and-model-street-networks"><span class="header-section-number">6.2.2</span> Download and model Street Networks</h3>
<p>The <a href="https://osmnx.readthedocs.io/en/stable/osmnx.html#module-osmnx.graph"><code>osmnx.graph</code>module</a> downloads data to construct a routable road network graph, based on an user-defined area of interest. This area of interest can be specified, for instance, using a place name, a bounding box, or a polygon. In the place name query, OSMnx uses the Nominatim Geocoding API. This means that place names should exist in the OpenStreetMap database (run a test search at <a href="https://www.openstreetmap.org/">openstreetmap.org</a> or <a href="https://nominatim.openstreetmap.org/ui/search.html">nominatim.openstreetmap.org</a>). <code>OSMnx</code>, amongst its several functionalities, lets you analyse, plot, and export the network in different file formats. The downloaded street networks are by default <strong>directed</strong> and preserve one-way directionality. For a more in-depth demonstration of creating street networks, see <a href="03-graph-place-queries.ipynb">this notebook</a>.</p>
<p>You can download a street network by providing OSMnx any of the following (demonstrated in the examples below): - a bounding box - a lat-lon point plus a distance - an address plus a distance - a place name or list of place names (to automatically geocode and get the boundary of) - a polygon of the desired street network’s boundaries - a .osm formatted xml file</p>
<p>You can also specify several different network types: - <code>drive</code> - get drivable public streets (but not service roads) - <code>drive_service</code> - get drivable streets, including service roads - <code>walk</code> - get all streets and paths that pedestrians can use (this network type ignores one-way directionality) - <code>bike</code> - get all streets and paths that cyclists can use - <code>all</code> - download all non-private OSM streets and paths (this is the default network type unless you specify a different one) - <code>all_private</code> - download all OSM streets and paths, including private-access ones</p>
<section id="method-1-passing-a-bounding-box" class="level4" data-number="6.2.2.1">
<h4 data-number="6.2.2.1" class="anchored" data-anchor-id="method-1-passing-a-bounding-box"><span class="header-section-number">6.2.2.1</span> Method #1: Passing a bounding box</h4>
<p>This constructs the network from all the OSM nodes and ways within the bounding box. The plot function is built on <code>Matplotlib</code>, thus it follows the procedures and methods discussed in session II.</p>
<div id="cell-12" class="cell" data-execution_count="78">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># define a bounding box in San Francisco</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>north, south, east, west <span class="op">=</span> <span class="fl">37.79</span>, <span class="fl">37.78</span>, <span class="op">-</span><span class="fl">122.41</span>, <span class="op">-</span><span class="fl">122.43</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co"># define a bounding box around ITU</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>north, south, east, west <span class="op">=</span> <span class="fl">55.6646</span>, <span class="fl">55.6540</span>, <span class="fl">12.5767</span>, <span class="fl">12.6077</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co"># create network from that bounding box</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>G <span class="op">=</span> ox.graph_from_bbox(north, south, east, west, network_type<span class="op">=</span><span class="st">"drive_service"</span>)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>ox.plot_graph(G, node_color<span class="op">=</span><span class="st">"r"</span>, figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">8</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="w07_OSM_files/figure-html/cell-6-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="method-2-passing-a-lat-lon-point-and-bounding-box-distance-in-meters" class="level4" data-number="6.2.2.2">
<h4 data-number="6.2.2.2" class="anchored" data-anchor-id="method-2-passing-a-lat-lon-point-and-bounding-box-distance-in-meters"><span class="header-section-number">6.2.2.2</span> Method #2: Passing a lat-lon point and bounding box distance in meters</h4>
<p>This creates a bounding box <em>n</em> meters North, South, East, and West of the point, then constructs the network from all the OSM nodes and ways within the bounding box. <a href="https://bboxfinder.com">Here’s a useful tool for defining bboxes</a></p>
<div id="cell-14" class="cell" data-execution_count="93">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># define a point at the corner of California St and Mason St in SF</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>location_point <span class="op">=</span> (<span class="fl">37.791427</span>, <span class="op">-</span><span class="fl">122.410018</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co"># create bikeable network from point, inside bounding box of N, S, E, W each 750m from point</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>G <span class="op">=</span> ox.graph_from_point(location_point, dist<span class="op">=</span><span class="dv">750</span>, dist_type<span class="op">=</span><span class="st">"bbox"</span>, network_type<span class="op">=</span><span class="st">"bike"</span>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>ox.plot_graph(G, node_color<span class="op">=</span><span class="st">"r"</span>, figsize<span class="op">=</span>(<span class="dv">5</span>,<span class="dv">5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="w07_OSM_files/figure-html/cell-7-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="method-3-passing-a-lat-lon-point-and-network-distance-in-meters" class="level4" data-number="6.2.2.3">
<h4 data-number="6.2.2.3" class="anchored" data-anchor-id="method-3-passing-a-lat-lon-point-and-network-distance-in-meters"><span class="header-section-number">6.2.2.3</span> Method #3: Passing a lat-lon point and <em>network</em> distance in meters</h4>
<p>This creates a bounding box <em>n</em> meters North, South, East, and West of the point, then constructs the network from all the OSM nodes and ways within the bounding box. Then it truncates the network by removing all nodes further than <em>n</em> meters from the point along the network.</p>
<div id="cell-16" class="cell" data-execution_count="94">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>location_point <span class="op">=</span> (<span class="fl">53.40</span>, <span class="op">-</span><span class="fl">2.99</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co"># create network only of nodes within 750m along the network from point</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>G1 <span class="op">=</span> ox.graph_from_point(location_point, dist<span class="op">=</span><span class="dv">1000</span>, dist_type<span class="op">=</span><span class="st">"network"</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>ox.plot_graph(G1, node_color<span class="op">=</span><span class="st">"none"</span>, figsize<span class="op">=</span>(<span class="dv">5</span>,<span class="dv">5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="w07_OSM_files/figure-html/cell-8-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p><em>Note</em> the plot above shows the network within 750m (traveling distance along the network) from the <code>location_point</code>. By default, the <code>network_type</code> parameter value is <code>all</code>, meaning that we do not filter out paths that restrict certain types of traffic. This also means that one-way streets are honored as one-way and you cannot travel the wrong direction down them. Thus, the 750m takes into account only those nodes you can reach within 500m while only traveling in the allowed direction of the street. Instead (below), we can specify <code>network_type='walk'</code> to build a street network only of paths that walking is allowed on. This also makes every path bi-directional in the directed network, because you can walk in either direction on the sidewalk of a one-way street. The 750m now takes into account those nodes you can reach within 750m while traveling in either direction (even if it’s a one-way street).</p>
<div id="cell-18" class="cell" data-execution_count="96">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create network only of nodes within 750m walking along the network from point, only walkable edges</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>G2 <span class="op">=</span> ox.graph_from_point(location_point, dist<span class="op">=</span><span class="dv">750</span>, dist_type<span class="op">=</span><span class="st">"network"</span>, network_type<span class="op">=</span><span class="st">"walk"</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>ox.plot_graph(G2, node_color<span class="op">=</span><span class="st">"none"</span>, figsize<span class="op">=</span>(<span class="dv">5</span>,<span class="dv">5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="w07_OSM_files/figure-html/cell-9-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="method-4-passing-an-address-and-distance-bounding-box-or-network-in-meters" class="level4" data-number="6.2.2.4">
<h4 data-number="6.2.2.4" class="anchored" data-anchor-id="method-4-passing-an-address-and-distance-bounding-box-or-network-in-meters"><span class="header-section-number">6.2.2.4</span> Method #4, Passing an address and distance (<em>bounding box</em> or <em>network</em>) in meters</h4>
<p>This geocodes the address, creates a bounding box, downloads the network, then truncates it by network distance (if distance_type=‘network’).</p>
<div id="cell-20" class="cell" data-execution_count="97">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># network from address, including only nodes within 1km along the network from the address</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>G <span class="op">=</span> ox.graph_from_address(address<span class="op">=</span><span class="st">"350 5th Ave, New York, NY"</span>, dist<span class="op">=</span><span class="dv">1000</span>, dist_type<span class="op">=</span><span class="st">"network"</span>, network_type<span class="op">=</span><span class="st">"drive"</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>ox.plot_graph(G, node_color<span class="op">=</span><span class="st">"r"</span>, figsize<span class="op">=</span>(<span class="dv">5</span>,<span class="dv">5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="w07_OSM_files/figure-html/cell-10-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="method-5-passing-a-place-name" class="level4" data-number="6.2.2.5">
<h4 data-number="6.2.2.5" class="anchored" data-anchor-id="method-5-passing-a-place-name"><span class="header-section-number">6.2.2.5</span> Method #5: Passing a place name</h4>
<p>This geocodes the place name, gets the place’s boundary shape polygon and bounding box, downloads the network within the bounding box, then truncates it to the place’s boundary polygon.</p>
<div id="cell-22" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>G <span class="op">=</span> ox.graph_from_place(<span class="st">"Bastia, Corsica"</span>, network_type<span class="op">=</span><span class="st">"drive"</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>ox.plot_graph(G, node_color<span class="op">=</span><span class="st">"none"</span>) <span class="co"># without plotting nodes</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="w07_OSM_files/figure-html/cell-11-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Be aware that this is a <code>MultiDiGraph</code>, i.e.&nbsp;a multigraph (parallel edges are possible) that is directed. Because there can be multiple links between a pair of nodes, each link is identified with a triple: (node1id, node2id, counter)</p>
<div id="cell-24" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="bu">list</span>(G.edges)[:<span class="dv">10</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>[(60370565, 338870652, 0),
 (60370565, 338870615, 0),
 (60370586, 338870618, 0),
 (60370599, 338870618, 0),
 (60370599, 60370602, 0),
 (60370602, 60370612, 0),
 (60370602, 60370599, 0),
 (60370612, 721266231, 0),
 (60370612, 60370602, 0),
 (60370622, 2358639572, 0)]</code></pre>
</div>
</div>
<p>These values above correspond to <code>u</code>, <code>v</code> and <code>key</code>. More on that later, but, essentially, <code>u</code> is the id of the “from-node” and <code>v</code> the id of the “to-node”</p>
</section>
<section id="method-6-passing-a-poylgon-in-the-wgs-crs" class="level4" data-number="6.2.2.6">
<h4 data-number="6.2.2.6" class="anchored" data-anchor-id="method-6-passing-a-poylgon-in-the-wgs-crs"><span class="header-section-number">6.2.2.6</span> Method #6 Passing a Poylgon in the WGS crs</h4>
<div id="cell-27" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get the boundary polygon for Sarajevo, and plot it</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>city <span class="op">=</span> ox.geocode_to_gdf(<span class="st">"Sarajevo, Bosnia"</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>city_proj <span class="op">=</span> ox.project_gdf(city)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> city_proj.plot(fc<span class="op">=</span><span class="st">"gray"</span>, ec<span class="op">=</span><span class="st">"none"</span>)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>ax.axis(<span class="st">"off"</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="w07_OSM_files/figure-html/cell-13-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-28" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>sarajevo <span class="op">=</span> ox.geocode_to_gdf(<span class="st">"Sarajevo, Bosnia"</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>polygon <span class="op">=</span> sarajevo[<span class="st">"geometry"</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>G <span class="op">=</span> ox.graph_from_polygon(polygon, network_type<span class="op">=</span><span class="st">"drive_service"</span>)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>ox.plot_graph(G, node_size<span class="op">=</span><span class="dv">0</span>, edge_color<span class="op">=</span><span class="st">"w"</span>, edge_linewidth<span class="op">=</span><span class="fl">0.3</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="w07_OSM_files/figure-html/cell-14-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="simplifying-and-cleaning-the-street-network-topology" class="level3" data-number="6.2.3">
<h3 data-number="6.2.3" class="anchored" data-anchor-id="simplifying-and-cleaning-the-street-network-topology"><span class="header-section-number">6.2.3</span> Simplifying and Cleaning the Street Network Topology</h3>
<p>Simplification is normally done by <code>OSMnx</code> automatically under the hood, but we can break it out to see how it works. OpenStreetMap nodes are weird. They include intersections, but they also include all the points along a single block where the street curves. The latter are not nodes in the graph theory sense, so we remove them algorithmically and consolidate the set of edges between “true” network nodes into a single edge. There are two simplification modes, strict and non-strict. The main difference is that unlike strict mode, non-strict mode allows simplification to an “expansion graph” (i.e., if the graph were undirected, nodes with degree 2 as long as the incident edges have different OSM IDs).</p>
<div id="cell-30" class="cell" data-execution_count="98">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create a network around some (lat, lng) point but do not simplify it yet</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>location_point <span class="op">=</span> (<span class="fl">33.299896</span>, <span class="op">-</span><span class="fl">111.831638</span>)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>G <span class="op">=</span> ox.graph_from_point(location_point, network_type<span class="op">=</span><span class="st">"drive_service"</span>, dist<span class="op">=</span><span class="dv">500</span>, simplify<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>ox.plot_graph(G, node_color<span class="op">=</span><span class="st">"r"</span>, figsize<span class="op">=</span>(<span class="dv">5</span>,<span class="dv">5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="w07_OSM_files/figure-html/cell-15-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-31" class="cell" data-execution_count="99">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># turn off strict mode and see what nodes we'd remove, in yellow</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> [<span class="st">"r"</span> <span class="cf">if</span> ox.simplification._is_endpoint(G, node) <span class="cf">else</span> <span class="st">"y"</span> <span class="cf">for</span> node <span class="kw">in</span> G.nodes()]</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> ox.plot_graph(G, node_color<span class="op">=</span>colors, figsize<span class="op">=</span>(<span class="dv">5</span>,<span class="dv">5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="w07_OSM_files/figure-html/cell-16-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The yellow markers above are OSM nodes. We’ll remove the nodes in yellow as they’re not real network nodes (intersections/dead-ends).</p>
<div id="cell-33" class="cell" data-execution_count="100">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># simplify the network</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>G <span class="op">=</span> ox.simplify_graph(G)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>ox.plot_graph(G, node_color<span class="op">=</span><span class="st">"r"</span>, figsize<span class="op">=</span>(<span class="dv">5</span>,<span class="dv">5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="w07_OSM_files/figure-html/cell-17-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<section id="optional-complex-intersection-consolidation" class="level4" data-number="6.2.3.1">
<h4 data-number="6.2.3.1" class="anchored" data-anchor-id="optional-complex-intersection-consolidation"><span class="header-section-number">6.2.3.1</span> Optional: Complex intersection consolidation</h4>
<p>Many real-world street networks feature complex intersections and traffic circles, resulting in a cluster of graph nodes where there is really just one true intersection. Similarly, divided roads are often represented by separate centerline edges: the intersection of two divided roads thus creates 4 nodes, representing where each edge intersects a perpendicular edge, but these 4 nodes represent a single intersection in the real world. Traffic circles similarly create a cluster of nodes where each street’s edge intersects the roundabout.</p>
<p><code>OSMnx</code> can consolidate nearby intersections and optionally rebuild the graph’s topology.</p>
<div id="cell-35" class="cell" data-execution_count="101">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get a street network and plot it with all edge intersections</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>point <span class="op">=</span> <span class="fl">55.667708</span>, <span class="fl">12.596266</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>G <span class="op">=</span> ox.graph_from_point(point, network_type<span class="op">=</span><span class="st">"drive"</span>, dist<span class="op">=</span><span class="dv">500</span>)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>ox.plot_graph(G, node_color<span class="op">=</span><span class="st">"r"</span>, figsize<span class="op">=</span>(<span class="dv">5</span>,<span class="dv">5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="w07_OSM_files/figure-html/cell-18-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Notice the complex intersections creating clusters of nodes.</p>
<p>We’ll specify that any nodes with 15 meter buffers of each other in this network are part of the same intersection. Adjust this tolerance based on the street design standards in the community you are examining, and use a projected graph to work in meaningful units like meters. We’ll also specify that we do not want dead-ends returned in our list of consolidated intersections.</p>
<div id="cell-37" class="cell" data-execution_count="104">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get a GeoSeries of consolidated intersections</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>G_proj <span class="op">=</span> ox.project_graph(G)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>intersections <span class="op">=</span> ox.consolidate_intersections(G_proj, rebuild_graph<span class="op">=</span><span class="va">False</span>, tolerance<span class="op">=</span><span class="dv">15</span>, dead_ends<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co"># compare to number of nodes in original graph</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">len</span>(intersections), <span class="st">"vs"</span>, <span class="bu">len</span>(G))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>73 vs 122</code></pre>
</div>
</div>
<p>Note that these cleaned up intersections give us more accurate intersection counts and densities, but do not alter or integrate with the network’s topology. To do that, we need to <strong>rebuild the graph</strong>.</p>
<div id="cell-39" class="cell" data-execution_count="102">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># consolidate intersections and rebuild graph topology</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="co"># this reconnects edge geometries to the new consolidated nodes</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>cleaned <span class="op">=</span> ox.consolidate_intersections(G_proj, rebuild_graph<span class="op">=</span><span class="va">True</span>, tolerance<span class="op">=</span><span class="dv">15</span>, dead_ends<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>ox.plot_graph(cleaned, node_color<span class="op">=</span><span class="st">"r"</span>, figsize<span class="op">=</span>(<span class="dv">5</span>,<span class="dv">5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="w07_OSM_files/figure-html/cell-20-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Notice how many nodes are merged into a new single centroid node, with edge geometries extended to connect to it. Similar consolidation occurs at the intersection of the divided roads.</p>
<p><strong>Note</strong></p>
<p>Running <code>consolidate_intersections</code> with <code>rebuild_graph=True</code> may yield somewhat (but not very) different intersection counts/densities compared to <code>rebuild_graph=False</code>. The difference lies in that the latter just merges buffered node points that overlap, whereas the former checks the topology of the overlapping node buffers before merging them. This prevents topologically remote but spatially proximate nodes from being merged. For example: - A street intersection may lie directly below a freeway overpass’s intersection with an on-ramp. We would not want to merge these together and connect their edges: they are distinct junctions in the system of roads. - In a residential neighbourhood, a bollarded street may create a dead-end immediately next to an intersection or traffic circle. We would not want to merge this dead-end with the intersection and connect their edges.</p>
<p>These examples illustrate (two-dimensional) geometric proximity, but topological remoteness. Accordingly, in some situations we may expect higher intersection counts when using <code>rebuild_graph=True</code> because it is more cautious with merging in these cases. The trade-off is that it has higher time complexity than <code>rebuild_graph=False</code>.</p>
</section>
</section>
<section id="from-osmnx-to-networkx-and-geopandas-classes" class="level3" data-number="6.2.4">
<h3 data-number="6.2.4" class="anchored" data-anchor-id="from-osmnx-to-networkx-and-geopandas-classes"><span class="header-section-number">6.2.4</span> From OSMNX to NetworkX and Geopandas Classes</h3>
<p>Now, we have seen how to use some basic <code>osmnx</code> functions to obtain a graph representation of the street network. While this is simple and straightforward, I advise working on the street network represented as <code>geopandas.GeoDataFrame</code>s and <code>networkx</code> graphs. While at the beginning this may be more tedious, it also gives us much more control, both in terms of visualisation and analysis depth. Before proceeding, it is important to keep in mind what type of graphs can be modelled through OSMNx and NetworkX, and what that means for the infrastructure we are modelling.</p>
<p><img src="../labs_img/graph_types.png" width="70%"></p>
<p>Have a look at NetworkX <a href="https://networkx.org/documentation/stable/reference/classes/index.html">documentation</a> for details.</p>
<p><strong>By default, the graphs obtained through OSMNX are ‘MultiDiGraph’</strong></p>
<div id="cell-42" class="cell" data-execution_count="50">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>siracusa_graph <span class="op">=</span> ox.graph_from_address(<span class="st">"Largo XXV Luglio, Siracusa"</span>, network_type<span class="op">=</span><span class="st">"all"</span>, dist <span class="op">=</span> <span class="dv">2500</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>sicily_epsg <span class="op">=</span> <span class="st">'EPSG:23030'</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>nodes <span class="op">=</span> ox.graph_to_gdfs(siracusa_graph, nodes<span class="op">=</span><span class="va">True</span>, node_geometry<span class="op">=</span><span class="va">True</span>, edges <span class="op">=</span> <span class="va">False</span>).to_crs(crs <span class="op">=</span> <span class="dv">23030</span>)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>edges <span class="op">=</span> ox.graph_to_gdfs(siracusa_graph, nodes<span class="op">=</span><span class="va">False</span>, edges <span class="op">=</span>  <span class="va">True</span>, fill_edge_geometry<span class="op">=</span><span class="va">True</span>).to_crs(crs <span class="op">=</span> <span class="dv">23030</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-43" class="cell" data-execution_count="51">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>edges.plot(lw <span class="op">=</span> <span class="fl">0.2</span>, color <span class="op">=</span> <span class="st">'red'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="w07_OSM_files/figure-html/cell-22-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We can visualise major roads on top of the street network:</p>
<div id="cell-45" class="cell" data-execution_count="52">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> edges[edges.highway.isin([<span class="st">'primary'</span>, <span class="st">'secondary'</span>])].plot()</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>edges.plot(ax <span class="op">=</span> ax, lw <span class="op">=</span> <span class="fl">0.2</span>, color <span class="op">=</span> <span class="st">'red'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="w07_OSM_files/figure-html/cell-23-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-46" class="cell" data-execution_count="59">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>edges.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="59">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">osmid</th>
<th data-quarto-table-cell-role="th">highway</th>
<th data-quarto-table-cell-role="th">maxspeed</th>
<th data-quarto-table-cell-role="th">oneway</th>
<th data-quarto-table-cell-role="th">reversed</th>
<th data-quarto-table-cell-role="th">length</th>
<th data-quarto-table-cell-role="th">geometry</th>
<th data-quarto-table-cell-role="th">name</th>
<th data-quarto-table-cell-role="th">lanes</th>
<th data-quarto-table-cell-role="th">junction</th>
<th data-quarto-table-cell-role="th">ref</th>
<th data-quarto-table-cell-role="th">bridge</th>
<th data-quarto-table-cell-role="th">access</th>
<th data-quarto-table-cell-role="th">service</th>
<th data-quarto-table-cell-role="th">tunnel</th>
<th data-quarto-table-cell-role="th">width</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">u</th>
<th data-quarto-table-cell-role="th">v</th>
<th data-quarto-table-cell-role="th">key</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td rowspan="3" data-quarto-table-cell-role="th" data-valign="top">33566408</td>
<td data-quarto-table-cell-role="th">297074052</td>
<td data-quarto-table-cell-role="th">0</td>
<td>828152472</td>
<td>secondary</td>
<td>50</td>
<td>False</td>
<td>False</td>
<td>63.755</td>
<td>LINESTRING (2132529.446 4262765.911, 2132466.8...</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9130394527</td>
<td data-quarto-table-cell-role="th">0</td>
<td>5028297</td>
<td>residential</td>
<td>50</td>
<td>True</td>
<td>False</td>
<td>46.925</td>
<td>LINESTRING (2132529.446 4262765.911, 2132535.5...</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">7876226633</td>
<td data-quarto-table-cell-role="th">0</td>
<td>[828152472, 836932525]</td>
<td>secondary</td>
<td>50</td>
<td>False</td>
<td>True</td>
<td>26.804</td>
<td>LINESTRING (2132529.446 4262765.911, 2132538.7...</td>
<td>Via Francesco Crispi</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td rowspan="2" data-quarto-table-cell-role="th" data-valign="top">33566411</td>
<td data-quarto-table-cell-role="th">8185067296</td>
<td data-quarto-table-cell-role="th">0</td>
<td>881159784</td>
<td>secondary</td>
<td>50</td>
<td>True</td>
<td>False</td>
<td>3.544</td>
<td>LINESTRING (2133165.090 4262581.928, 2133165.4...</td>
<td>NaN</td>
<td>2</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">33566412</td>
<td data-quarto-table-cell-role="th">0</td>
<td>28114161</td>
<td>residential</td>
<td>NaN</td>
<td>True</td>
<td>False</td>
<td>62.841</td>
<td>LINESTRING (2133165.090 4262581.928, 2133163.3...</td>
<td>Via Nino Bixio</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-47" class="cell" data-execution_count="60">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>nodes.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="60">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">y</th>
<th data-quarto-table-cell-role="th">x</th>
<th data-quarto-table-cell-role="th">street_count</th>
<th data-quarto-table-cell-role="th">highway</th>
<th data-quarto-table-cell-role="th">geometry</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">osmid</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">33566408</td>
<td>37.068451</td>
<td>15.280819</td>
<td>3</td>
<td>NaN</td>
<td>POINT (2132529.446 4262765.911)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">33566411</td>
<td>37.065793</td>
<td>15.287216</td>
<td>4</td>
<td>NaN</td>
<td>POINT (2133165.090 4262581.928)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">33566412</td>
<td>37.065258</td>
<td>15.286985</td>
<td>3</td>
<td>NaN</td>
<td>POINT (2133156.199 4262517.746)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">33566413</td>
<td>37.064692</td>
<td>15.286909</td>
<td>3</td>
<td>NaN</td>
<td>POINT (2133162.078 4262452.755)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">33566854</td>
<td>37.060586</td>
<td>15.293191</td>
<td>3</td>
<td>NaN</td>
<td>POINT (2133819.897 4262104.005)</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>As you can see an edge’s index is a <code>MultiIndex</code> given by <code>u</code>, <code>v</code>, and <code>key</code>. <code>u</code> and <code>v</code> in <code>networkx</code> language stand for “from-node” and “to-node”. <code>key</code>, on the other hand, indicates whether more than one edge links <code>u</code> and <code>v</code>. When a pair of <code>u</code> and <code>v</code> nodes have more then one edge, every other edge will have an incremental <code>key</code> value (the second one 1, the third one 2, etc., very rare that there are more than two edges per pair of nodes). This means that we are dealing with a <code>MultiGraph</code> representation of the street network. In other words, we have two street segments connecting the same two nodes in different directions. This could, for example, indicate that the directionality is accounted for (one-way segments). Based on our objective and analysis, such an aspect might be relevant, or not.</p>
<section id="reconverting-to-a-multigraphmultidigraph" class="level4" data-number="6.2.4.1">
<h4 data-number="6.2.4.1" class="anchored" data-anchor-id="reconverting-to-a-multigraphmultidigraph"><span class="header-section-number">6.2.4.1</span> (Re)converting to a <code>MultiGraph</code>/<code>MultiDiGraph</code></h4>
<p>First, we get rid of the <code>pandas</code> <code>MultiIndex</code> and we verify whether we are working with bidirectional edges.</p>
<div id="cell-50" class="cell" data-execution_count="69">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>edges.reset_index(inplace <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>edges[<span class="st">'key'</span>].<span class="bu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="69">
<pre><code>95</code></pre>
</div>
</div>
<div id="cell-51" class="cell" data-execution_count="73">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> networkx <span class="im">as</span> nx</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>Mg <span class="op">=</span> nx.MultiGraph()   </span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>Mg.add_nodes_from(nodes.index)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Copying the nodes’ attributes (this step is not particularly essential unless we need some information associated with the nodes that we want to use when executing <code>networkx</code> methods). Anything else we can rely on the information that is in the <code>GeoDataFrame</code>.</p>
<div id="cell-53" class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># add the nodes' attributes</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>attributes <span class="op">=</span> nodes.to_dict()</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> attribute_name <span class="kw">in</span> nodes.columns:</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> nodes[attribute_name].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="bu">type</span>(x) <span class="op">==</span> <span class="bu">list</span>).<span class="bu">any</span>(): </span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span> </span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># only add this attribute to nodes which have a non-null value for it</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    attribute_values <span class="op">=</span> {k:v <span class="cf">for</span> k, v <span class="kw">in</span> attributes[attribute_name].items() <span class="cf">if</span> pd.notnull(v)}</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    nx.set_node_attributes(Mg, name<span class="op">=</span>attribute_name, values<span class="op">=</span>attribute_values)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We do something similar for edges. In this case, it is more likely that there is information that we want to copy, e.g.&nbsp;the length of the edges, into the <code>MultiGraph</code>.</p>
<div id="cell-55" class="cell" data-execution_count="70">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>edges[<span class="st">'length'</span>] <span class="op">=</span> edges.geometry.length</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="co"># add the edges and attributes that are not u, v, key, null, or of type list</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="co">## u, v, and key are added directly as you can see from the last line</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> row <span class="kw">in</span> edges.itertuples():</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    attrs <span class="op">=</span> {label: value <span class="cf">for</span> label, value <span class="kw">in</span> row._asdict().items() <span class="cf">if</span> (label <span class="kw">not</span> <span class="kw">in</span> [<span class="st">'u'</span>, <span class="st">'v'</span>, <span class="st">'key'</span>]) <span class="kw">and</span> </span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>             (<span class="bu">isinstance</span>(value, <span class="bu">list</span>) <span class="kw">or</span> pd.notnull(value))}</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    Mg.add_edge(row.u, row.v, key<span class="op">=</span>row.key, <span class="op">**</span>attrs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="converting-to-a-graphdigraph" class="level4" data-number="6.2.4.2">
<h4 data-number="6.2.4.2" class="anchored" data-anchor-id="converting-to-a-graphdigraph"><span class="header-section-number">6.2.4.2</span> Converting to a <code>Graph</code>/<code>DiGraph</code></h4>
<p>In this case, we need to get rid of the “duplicated” edges. For the sake of simplicity, we remove al the edges with <code>key</code> equal to 1. This is a very rough approach.</p>
<div id="cell-58" class="cell" data-execution_count="106">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>edges_copy <span class="op">=</span> edges[edges.key <span class="op">==</span> <span class="dv">0</span>].copy()</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>G <span class="op">=</span> nx.Graph()   </span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>G.add_nodes_from(nodes.index)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, we copy the attributes with the same approach used before, although, this time, without adding the <code>key</code> value to the edges. The function <code>add_edge</code> of the class the <code>graph</code> does not take the <code>key</code> argument as there could be only one edge between two nodes.</p>
<div id="cell-60" class="cell" data-execution_count="107">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ignore fields containing values of type list</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>attributes <span class="op">=</span> nodes.to_dict()</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> attribute_name <span class="kw">in</span> nodes.columns:</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> nodes[attribute_name].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="bu">type</span>(x) <span class="op">==</span> <span class="bu">list</span>).<span class="bu">any</span>(): </span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span>    </span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># only add this attribute to nodes which have a non-null value for it</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>    attribute_values <span class="op">=</span> {k: v <span class="cf">for</span> k, v <span class="kw">in</span> attributes[attribute_name].items() <span class="cf">if</span> pd.notnull(v)}</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>    nx.set_node_attributes(G, name<span class="op">=</span>attribute_name, values<span class="op">=</span>attribute_values)</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="co"># add the edges and attributes that are not u, v, null, or of type list</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a><span class="co">## u, and v are added directly as you can see from the last line</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> row <span class="kw">in</span> edges_copy.itertuples():</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>    attrs <span class="op">=</span> {label: value <span class="cf">for</span> label, value <span class="kw">in</span> row._asdict().items() <span class="cf">if</span> (label <span class="kw">not</span> <span class="kw">in</span> [<span class="st">'u'</span>, <span class="st">'v'</span>]) <span class="kw">and</span> (<span class="bu">isinstance</span>(value, <span class="bu">list</span>) <span class="kw">or</span> pd.notnull(value))}</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>    G.add_edge(row.u, row.v, <span class="op">**</span>attrs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And just to be sure:</p>
<div id="cell-62" class="cell" data-execution_count="116">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(<span class="bu">list</span>(G.nodes())) <span class="op">==</span> <span class="bu">len</span>(nodes)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="116">
<pre><code>True</code></pre>
</div>
</div>
</section>
</section>
</section>
<section id="routing-with-networkx" class="level2" data-number="6.3">
<h2 data-number="6.3" class="anchored" data-anchor-id="routing-with-networkx"><span class="header-section-number">6.3</span> Routing with NetworkX</h2>
<p>Both with <code>osmnx</code> and <code>networkx</code> we can compute paths across the network, of different kinds, with different weights and methods (see <a href="https://networkx.org/documentation/stable/reference/algorithms/shortest_paths.html">here</a>. Shortest paths, while they seem to allude to an explicit reference to distance or time, may be computed in relation to other weights or costs, based on the purposes of the user.</p>
<div id="cell-65" class="cell" data-execution_count="122">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Get a list of all nodes in the graph</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>nodes <span class="op">=</span> <span class="bu">list</span>(G.nodes())</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Select a random node</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>origin_node <span class="op">=</span> random.choice(nodes)</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span>(<span class="va">True</span>):</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>    destination_node <span class="op">=</span> random.choice(nodes)</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> destination_node <span class="op">!=</span> origin_node:</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>path_nodes <span class="op">=</span> nx.shortest_path(G, source<span class="op">=</span>origin_node, target<span class="op">=</span>destination_node, weight<span class="op">=</span><span class="st">'length'</span>, method<span class="op">=</span><span class="st">'dijkstra'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>shortest_path</code>, the simplest function for computing shortest paths in <code>networkx</code>, returns the list of nodes traversed by the path, including the origin and the destination nodes. We have to transform the sequence of nodes into a sequence of edges to get the corresponding route.</p>
<div id="cell-67" class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>path_edges <span class="op">=</span> [(path_nodes[i], path_nodes[i <span class="op">+</span> <span class="dv">1</span>]) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(path_nodes) <span class="op">-</span> <span class="dv">1</span>)] </span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>path_edges[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>When we look at the elements of the edges sequence, we can see that this is a tuple containing the index of the <code>u</code> and <code>v</code> nodes that the edge links together. This is the <code>networkx</code> representations of an edge inside a <code>graph</code>.</p>
<div id="cell-69" class="cell" data-execution_count="133">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>path_edges[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="133">
<pre><code>(567053470, 1839236315)</code></pre>
</div>
</div>
<p>However, for that edge, we want to get the attribute that refers to the index in the <code>edges_copy</code> <code>GeoDataFrame</code>. For that, We use a list comprehension.</p>
<div id="cell-71" class="cell" data-execution_count="137">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>path_edges <span class="op">=</span> [G.edges[edge][<span class="st">'index'</span>] <span class="cf">for</span> edge <span class="kw">in</span> path_edges]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And then we can plot the route.</p>
<div id="cell-73" class="cell" data-execution_count="141">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> edges_copy[edges_copy.index.isin(path_edges)].plot()</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>edges_copy.plot(ax <span class="op">=</span> ax, lw <span class="op">=</span> <span class="fl">0.2</span>, color <span class="op">=</span> <span class="st">'red'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="w07_OSM_files/figure-html/cell-37-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div class="alert alert-success">
<p><strong>Exercise</strong>:</p>
<p>Compute different shortest paths between a node (1) of your choice and a set of 20 other random nodes, for a driver and a walker. Visualise and compare the results. In order to differentiate the users, you are expected to consider their travelling speeds, in relation to the speed limit of the edges. Consider that, at least for the driver, you may want to do that in a <code>MultiDiGraph</code>.</p>
<p>You can use as case-study one of the graphs used above for Siracusa (Italy) or Sarajevo (Bosnia). Otherwise, just pick a city you like.</p>
</div>
</section>
<section id="fetching-other-networks-with-osmnx" class="level2" data-number="6.4">
<h2 data-number="6.4" class="anchored" data-anchor-id="fetching-other-networks-with-osmnx"><span class="header-section-number">6.4</span> Fetching other networks with OSMNX</h2>
<p>When downloading graphs, one can also pass a <code>custom_filter</code> to specify what OSM ways/routes/links they want represented in their graph. This would override the fact that, by default, graph functions in <code>osmnx</code> fetch street networks.</p>
<p>From <code>osmnx</code> documentation: <code>custom_filter</code> (string) – a custom ways filter to be used instead of the network_type presets e.g., <code>[“power”~”line”]</code> or <code>[“highway”~”motorway|trunk”]</code>.</p>
<p>This method does not work with bus services, since they are not stored in OpenStreetMap Data as Links but rather relations. See <a href="https://wiki.openstreetmap.org/wiki/Buses">here</a> for more info.</p>
<div id="cell-79" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># railway infrastructures</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>place <span class="op">=</span> <span class="st">"Milan, Italy"</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>G <span class="op">=</span> ox.graph_from_place(place, custom_filter<span class="op">=</span><span class="st">'["railway"~"rail"]'</span>)</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>ox.plot_graph(G, edge_color<span class="op">=</span><span class="st">"c"</span>, edge_linewidth<span class="op">=</span><span class="fl">0.5</span>, node_size<span class="op">=</span><span class="dv">0</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="w07_OSM_files/figure-html/cell-40-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-80" class="cell" data-execution_count="160">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># network of the canals of amsterdam</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>place <span class="op">=</span> <span class="st">"Amsterdam, Netherlands"</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>G <span class="op">=</span> ox.graph_from_place(place, custom_filter<span class="op">=</span><span class="st">'["waterway"~"canal"]'</span>)</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>ox.plot_graph(G, edge_color<span class="op">=</span><span class="st">"c"</span>, edge_linewidth<span class="op">=</span><span class="dv">1</span>, node_size<span class="op">=</span><span class="dv">0</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="w07_OSM_files/figure-html/cell-41-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="retrieving-other-osm-data" class="level2" data-number="6.5">
<h2 data-number="6.5" class="anchored" data-anchor-id="retrieving-other-osm-data"><span class="header-section-number">6.5</span> Retrieving Other OSM data</h2>
<p>OSMNx power also lies on the fact that it allows obtaining any other element represented in OpenStreetMap data. You can use the same methods described above for graphs. Instead of using <code>graph_from_place</code>, you would use, for example, <code>features_from_place</code>, <code>features_from_address</code>, etc.</p>
<section id="fetching-building-footprints" class="level4" data-number="6.5.0.1">
<h4 data-number="6.5.0.1" class="anchored" data-anchor-id="fetching-building-footprints"><span class="header-section-number">6.5.0.1</span> Fetching Building Footprints</h4>
<div id="cell-83" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Specify the location and the data type</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>place <span class="op">=</span> <span class="st">'Torino, Italy'</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>tags <span class="op">=</span> {<span class="st">'building'</span>: <span class="va">True</span>}</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Fetch building footprints</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>buildings <span class="op">=</span> ox.features_from_place(place, tags<span class="op">=</span>tags)</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>buildings <span class="op">=</span> buildings[buildings.geometry.geom_type <span class="op">==</span> <span class="st">'Polygon'</span>]</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the building footprints</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> buildings.plot(figsize<span class="op">=</span>(<span class="dv">6</span>, <span class="dv">6</span>), color <span class="op">=</span> <span class="st">'orange'</span>)</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Building Footprints in Torino, Italy'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="water-bodies" class="level4" data-number="6.5.0.2">
<h4 data-number="6.5.0.2" class="anchored" data-anchor-id="water-bodies"><span class="header-section-number">6.5.0.2</span> Water bodies</h4>
<div id="cell-85" class="cell" data-execution_count="146">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Tags for waterbodies</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>water_tags <span class="op">=</span> {<span class="st">'natural'</span>: [<span class="st">'water'</span>]}</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Fetch water bodies</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>waterbodies <span class="op">=</span> ox.features_from_place(place, tags<span class="op">=</span>water_tags)</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot water bodies</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> waterbodies.plot(figsize<span class="op">=</span>(<span class="dv">6</span>, <span class="dv">6</span>), color<span class="op">=</span><span class="st">'blue'</span>)</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Waterbodies in Torino, Italy'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="146">
<pre><code>Text(0.5, 1.0, 'Waterbodies in Torino, Italy')</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="w07_OSM_files/figure-html/cell-43-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="pois" class="level4" data-number="6.5.0.3">
<h4 data-number="6.5.0.3" class="anchored" data-anchor-id="pois"><span class="header-section-number">6.5.0.3</span> POIs</h4>
<div id="cell-87" class="cell" data-execution_count="152">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Tags for POIs</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>poi_tags <span class="op">=</span> {<span class="st">'amenity'</span>: <span class="va">True</span>}</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Fetch POIs</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>pois <span class="op">=</span> ox.features_from_place(place, tags<span class="op">=</span>poi_tags)</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>pois <span class="op">=</span> pois[pois.geometry.geom_type <span class="op">==</span> <span class="st">'Point'</span>]</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot POIs</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> pois.plot(figsize<span class="op">=</span>(<span class="dv">6</span>, <span class="dv">6</span>), color<span class="op">=</span><span class="st">'red'</span>, markersize <span class="op">=</span> <span class="fl">0.5</span>)</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Points of Interest in Torino, Italy'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="152">
<pre><code>Text(0.5, 1.0, 'Points of Interest in Torino, Italy')</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="w07_OSM_files/figure-html/cell-44-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="public-transport-bus-stops" class="level4" data-number="6.5.0.4">
<h4 data-number="6.5.0.4" class="anchored" data-anchor-id="public-transport-bus-stops"><span class="header-section-number">6.5.0.4</span> Public Transport Bus Stops</h4>
<div id="cell-89" class="cell" data-execution_count="164">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Tags for public transport</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>tags <span class="op">=</span> {<span class="st">'public_transport'</span>: <span class="va">True</span>}</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Fetch public transport routes</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>pt_stops <span class="op">=</span> ox.features_from_place(place, tags<span class="op">=</span>tags)</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot bus routes</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> pt_stops.plot(figsize<span class="op">=</span>(<span class="dv">6</span>, <span class="dv">6</span>), color<span class="op">=</span><span class="st">'blue'</span>, markersize <span class="op">=</span> <span class="fl">0.5</span>)</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Public Transport Stops in Torino, Italy'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="164">
<pre><code>Text(0.5, 1.0, 'Public Transport Stops in Torino, Italy')</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="w07_OSM_files/figure-html/cell-45-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../labs/w05_dataArch.html" class="pagination-link  aria-label=" &lt;span="" architectures="" and="" tiles&lt;="" span&gt;"="">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Data Architectures and Tiles</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>Web Mapping and Geovisualisation by Gabriele Filomena and Elisabetta Pietrostefani.</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.dev/GDSL-UL/wma/blob/main/labs/w07_OSM.ipynb" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></div>
    <div class="nav-footer-right">
<p>This book was built with <a href="https://quarto.org/">Quarto</a>.</p>
</div>
  </div>
</footer>




</body></html>